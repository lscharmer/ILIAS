/**
 * This file is part of ILIAS, a powerful learning management system
 * published by ILIAS open source e-Learning e.V.
 *
 * ILIAS is licensed with the GPL-3.0,
 * see https://www.gnu.org/licenses/gpl-3.0.en.html
 * You should have received a copy of said license along with the
 * source code, too.
 *
 * If this is not the case or you just want to try ILIAS, you'll find
 * us at:
 * https://www.ilias.de
 * https://github.com/ILIAS-eLearning
 */
!function(e,t,s){"use strict";function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var n=i(e),r=i(t),o=i(s);const a=e=>"0".repeat(Math.max(0,2-String(e)).length)+e,l=e=>t=>{let s=e("timeformat");const i=new Date(t);return s=s.replace(/H/,a(i.getHours())),s=s.replace(/i/,a(i.getMinutes())),s=s.replace(/s/,a(i.getSeconds())),s};class c{#e;#t;#s;#i;#n;#r;#o;#a;#l;#c;#h;constructor(e,t,s,i,n,r){this.#e=e,this.#t=t,this.#s=s,this.#i=i,this.#n=n,this.#r=r,this.#l=d(["messageContainer"]),this.#l.setAttribute("aria-live","polite"),this.#c=d(["typing-info"]),this.#c.setAttribute("aria-live","polite"),this.#h=()=>{},this.#d(),this.clearMessages(),this.#u()}addMessage(e){this.#h();const t=d(["messageLine","chat",!e.target||e.target.public?"public":"private"]),s=()=>{console.log(e.type)};let i=null;const r=e=>{i=e},o={message:()=>{const s=function(e,t){const s=d(["message-body"]);return s.appendChild(e),s.appendChild(t),s}(function(e,t){const s=d(["time-info"]);return s.textContent=t(e.timestamp),s}(e,l(this.#r)),function(e){const t=d([],"p");return t.textContent=e.content,n.default.ExtLink.autolink(t),t}(e));var i;this.#a(new Date(e.timestamp))&&(this.#l.appendChild(function(e,t){const s=d(["separator"]),i=d([],"p");return i.textContent=t(e.timestamp),s.appendChild(i),s}(e,(i=this.#r,e=>{let t=i("dateformat");const s=new Date(e);return t=t.replace(/Y/,s.getFullYear()),t=t.replace(/m/,a(s.getMonth()+1)),t=t.replace(/d/,a(s.getDate())),t}))),r(null)),e.from.id===this.#t&&t.classList.add("myself"),this.#o&&this.#o.id===e.from.id&&this.#o.username===e.from.username?(this.#o.node.appendChild(s),r(this.#o)):(t.appendChild(function(e,t,s){const i=d(["user"],"span"),n=d(["user"],"span"),r=d([],"img"),o=d(["message-header"]);return i.textContent=s(e.timestamp),n.textContent=e.from.username,r.src=t.defaultImage(),t.imageOfUser(e.from).then(Reflect.set.bind(null,r,"src")),o.appendChild(r),o.appendChild(n),o.appendChild(i),o}(e,this.#i,l(this.#r))),t.appendChild(s),this.#l.appendChild(t),r({...e.from,node:t}))},connected:s,disconnected:s,private_room_entered:s,private_room_left:s,notice:()=>{const t=d(["separator","system-message"]),s=d([],"p");s.innerHTML=this.#r(e.content,e.data),t.appendChild(s),this.#l.appendChild(t)},error:s,userjustkicked:s};(o[e.type]||s)(),this.#o=i,this.#s.scrolling&&(this.#e.scrollTop=this.#l.getBoundingClientRect().height)}clearMessages(){this.#l.innerHTML="",this.#o=null,this.#a=h();const e=d(["separator"]),t=d([],"p");t.innerHTML=this.#r("welcome_to_chat"),e.appendChild(t),this.#l.appendChild(e),this.#h=e.remove.bind(e)}typingListChanged(){const e=Object.values(this.#n.all());0===e.length?this.#c.textContent="":1===e.length?this.#c.textContent=this.#r("chat_user_x_is_typing",e[0]):this.#c.textContent=this.#r("chat_users_are_typing")}enableAutoScroll(e){this.#s.scrolling=Boolean(e),this.#d()}enableSystemMessages(e){this.#s.show_auto_msg=Boolean(e),this.#d()}#u(){this.#e.appendChild(this.#l);const e=d(["fader"]);this.#e.appendChild(e),e.appendChild(this.#c)}#d(){this.#e.classList[this.#s.show_auto_msg?"remove":"add"]("hide-system-messages")}}const h=()=>{let e=null;return t=>{const s=!e||e.getDate()!=t.getDate()||e.getMonth()!=t.getMonth()||e.getFullYear()!=t.getFullYear();return e=t,s}};const d=(e,t)=>{const s=document.createElement(t||"div");return(e||[]).forEach((e=>s.classList.add(e))),s};class u{#e;#p;#g;#i;#m;#f;#v;#y;constructor(e,t,s,i,n){this.#e=e,this.#p=t,this.#g=s,this.#i=i,this.#m=e&&e.querySelector(".no_users"),this.#f={},this.#v=[],this.#y=n}userListChanged(e){e.removed.forEach((({key:e})=>this.remove(e))),e.added.forEach((({value:e})=>this.add(e)))}add(e){if(this.#f[e.id])return!1;const t=this.#b(e);return this.#g(e.id)||this.#v.push(String(e.id)),this.#e.appendChild(t),this.#f[e.id]=t,this.#S(),!0}remove(e){const t=this.#f[e];return!!t&&(t.remove(),this.#v=this.#v.filter((t=>t!==e)),delete this.#f[e],this.#S(),!0)}setUsers(e){const t=e.map((e=>String(e.id)));Object.keys(this.#f).filter((e=>!t.includes(e))).forEach(this.remove.bind(this)),e.forEach(this.add.bind(this))}static actionList(e,t,s,i){return[{name:"kick",label:e("kick"),callback:function(e){s("kick-modal").then((function(s){s&&t.kick(e)}))}},{name:"ban",label:e("ban"),callback:function(e){s("ban-modal").then((function(s){s&&t.ban(e)}))}},{name:"chat",label:e("start_private_chat"),callback:i}]}#b(e){const t=(new DOMParser).parseFromString(this.#p,"text/html").body.firstChild,s=t.querySelector("[data-placeholder=USERNAME]"),i=t.querySelector("img");return s.parentNode.replaceChild(document.createTextNode(e.username),s),i.setAttribute("src",this.#i.defaultImage()),this.#i.imageOfUser(e).then(i.setAttribute.bind(i,"src")),this.#g(e.id)&&t.classList.add("ilNoDisplay"),p(this.#y,e.id,t),t}#S(){this.#m.classList[this.#v.length?"add":"remove"]("ilNoDisplay")}}const p=(e,t,s)=>{s.querySelector(".chatroom-user-action-dropdown").classList.remove("ilNoDisplay");const i=s.querySelector(".ilChatroomDropdownOptions");e.forEach((e=>i.appendChild((e=>{const s=document.createElement("li"),i=document.createElement("a"),n=document.createElement("span");return s.appendChild(i),i.appendChild(n),n.textContent=e.label,i.addEventListener("click",(()=>e.callback(t))),s})(e))))};class g{#k;#C;#L;#_;#w;constructor(e,t){this.#k=e,this.#C=t,this.#L={},this.#_={},this.#w=()=>{}}imageOfUser(e){return this.#L[this.#I(e)]?Promise.resolve(this.#L[this.#I(e)]):this.#U(e)}imagesOfUsers(e){return Promise.all(e.map(this.imageOfUser.bind(this)))}defaultImage(){return this.#C}#U(e){return new Promise(((t,s)=>{const i=this.#I(e);this.#_[i]=this.#_[i]||{value:e,waiting:[]},this.#_[i].waiting.push({resolve:t,reject:s}),this.#w(),this.#w=clearTimeout.bind(null,setTimeout(this.#R.bind(this),20))}))}#R(){const e=Object.values(this.#_).map((({value:e})=>e)),t=fetch(this.#k,{method:"POST",body:JSON.stringify({profiles:e}),headers:{"Content-Type":"application/json"}}).then((e=>e.json()));t.then((e=>Object.entries(this.#E()).forEach((([t,{waiting:s}])=>s.forEach((({resolve:s,reject:i})=>{e[t]?(this.#L[t]=e[t],s(e[t])):i("Image not returned from server.")})))))),t.catch((e=>Object.values(this.#E()).flatMap((e=>e.waiting)).forEach((t=>t.reject(e)))))}#I(e){return JSON.stringify(e)}#T(e){return"object"==typeof e?JSON.stringify(e):e}#E(){const e=this.#_;return this.#_={},e}}const m=["padding-top","padding-bottom","padding-left","padding-right","margin-left","margin-right","margin-top","margin-bottom","width","font-size","font-family","font-style","font-weight","line-height","font-variant","text-transform","letter-spacing","border","box-sizing","display"],f=(e,t)=>{const s=window.getComputedStyle(e);m.forEach((function(e){t.style[e]=s[e]}))},v=e=>{let t="";return s=>{s!==t&&(e.style.height=s,t=s)}},y=e=>{const t=e.value;e.value="";const s=e.scrollHeight;e.value="\n";const i=e.scrollHeight-s;return e.value=t,i},b=(e,t)=>{const s=e.value;e.value="\n".repeat(t-1);const i=e.scrollHeight;return e.value=s,i},S=e=>{const t=document.createElement("textarea");return t.style.height=window.getComputedStyle(e).height,t.setAttribute("area-hidden","true"),t.readOnly=!0,t.disabled=!0,t},k=e=>{let t=()=>{const s=e();return t=()=>s,s};return()=>t()};function C(e,t,s){const i=S(t),n=v(t),r=k((()=>y(i))),o=k((()=>b(i,s))),a=()=>{i.value="";const e=i.scrollHeight,a=t.clientHeight;i.value=t.value;const l=i.scrollHeight,c=parseInt((l-e)/r()+1);l>e?n(c<=s?l+"px":o()+"px"):l<a&&n("")};return()=>{e.appendChild(i),f(t,i),a(),i.remove()}}class L{#q;#x;#M;#A;#n;#O;#j;#D;constructor(e,t,s,i,n,r,o){this.#q=e,this.#x=t,this.#M=s,this.#A=i,this.#n=n,this.#O=r,this.#j=o}init(e){this.#D=e,this.#D.on("message",this.#N.bind(this)),this.#D.on("connect",(()=>{this.#D.emit("login",this.#q.login,this.#q.id,this.#q.profile_picture_visible)})),this.#D.on("user_invited",this.#P.bind(this)),this.#D.on("private_room_entered",this.#H.bind(this)),this.#D.on("connected",this.#B.bind(this)),this.#D.on("userjustkicked",this.#J.bind(this)),this.#D.on("userjustbanned",this.#F.bind(this)),this.#D.on("clear",this.#K.bind(this)),this.#D.on("notice",this.#Y.bind(this)),this.#D.on("userStartedTyping",this.#Q.bind(this)),this.#D.on("userStoppedTyping",this.#z.bind(this)),this.#D.on("userlist",this.#$.bind(this)),this.#D.on("shutdown",(function(){this.#D.removeAllListeners(),this.#D.close(),window.location.href=this.#O})),window.addEventListener("beforeunload",(()=>{this.#D.close()}))}enterRoom(){this.#j.logServerRequest("enterRoom"),this.#D.emit("enterRoom",this.#A)}onLoggedIn(e){this.#D.on("loggedIn",e)}userStartedTyping(){this.#j.logServerRequest("userStartedTyping"),this.#D.emit("userStartedTyping",this.#A)}userStoppedTyping(){this.#j.logServerRequest("userStoppedTyping"),this.#D.emit("userStoppedTyping",this.#A)}sendMessage(e){this.#D.emit("message",e,this.#A)}#N(e){this.#M.addMessage(e)}#P(e){}#H(e){this.#j.logServerResponse("onPrivateRoomEntered")}#B(e){console.log("connected",e.users),Object.values(e.users).forEach((function(t){let s={id:t.id,username:t.login,profile_picture_visible:t.profile_picture_visible};this.#x.add(s),this.#M.addMessage({login:s.label,timestamp:e.timestamp,type:"connected"})}))}#J(e){this.#j.logServerResponse("onUserKicked"),this.#x.remove(this.#q.id),window.location.href=this.#O+"&msg=kicked"}#F(e){this.#D&&(this.#D.removeAllListeners(),this.#D.close()),window.location.href=this.#O+"&msg=banned"}#K(){this.#M.clearMessages()}#Y(e){this.#M.addMessage(e)}#Q(e){this.#j.logServerResponse("onUserStartedTyping");const t=JSON.parse(e.subscriber);e.roomId,this.#n.add(t.id,t.username)}#z(e){this.#j.logServerResponse("onUserStoppedTyping");const t=JSON.parse(e.subscriber);e.roomId,this.#n.remove(t.id)}#$(e){const t=e.users;this.#j.logServerResponse("onUserlist"),this.#x.setAll(Object.fromEntries(Object.values(t).map((e=>{const t={id:e.id,username:e.username,profile_picture_visible:e.profile_picture_visible};return[t.id,t]}))))}}const _=(e,t)=>Object.keys(e).filter((e=>!Reflect.has(t,e))).map((t=>({key:t,value:e[t]})));class w{#G;#V;constructor(){this.#G={},this.#V=[]}find(e){return this.#G[e]}has(e){return Reflect.has(this.#G,String(e))}onChange(e){this.#V.push(e)}add(e,t){e=String(e),this.#G[e]=t,this.#W({added:[{key:e,value:t}],removed:[]})}remove(e){if(e=String(e),!Reflect.has(this.#G,e))return;const t=this.#G[e];delete this.#G[e],this.#W({added:[],removed:[{key:e,value:t}]})}setAll(e){const t={added:_(e,this.#G),removed:_(this.#G,e)};this.#G=e,this.#W(t)}all(){return this.#G}#W(e){this.#V.forEach((t=>t(e)))}}class I{#X;#Z;#w;constructor(e){this.#X=e,this.#Z=!1,this.#w=()=>{},window.addEventListener("beforeunload",this.release.bind(this))}release(){this.#w(),this.#Z&&(this.#X.userStoppedTyping(),this.#Z=!1)}heartbeat(){this.#w(),this.#Z||(this.#X.userStartedTyping(),this.#Z=!0),this.#w=clearTimeout.bind(null,setTimeout(this.release.bind(this),5e3))}}class U{release(){}heartbeat(){}}var R=function(){const e={},t={};return{send(s,i){if(e[s])throw new Error("Name already provided.");e[s]=i;const n=t[s]||[];delete t[s],n.forEach((e=>e(i)))},onArrived(s,i){e[s]?i(e[s]):(t[s]=t[s]||[],t[s].push(i))}}}();const E=()=>{},T=(e=>{const t={};return s=>(t[s]||(t[s]=e(s)),t[s])})((e=>new Promise((t=>R.onArrived(e,(([e,s,i])=>{let n=E;e.querySelector("form").addEventListener("submit",(e=>(e.preventDefault(),n(!0),n=E,i(),!1))),t((()=>(s(),new Promise((e=>{n=e})))))}))))));class q{#ee;#j;constructor(e,t){this.#ee=e,this.#j=t}heartbeatInterval(e){const t=()=>{};window.setInterval((()=>this.#te("poll",{},t)),e)}leavePrivateRoom(){this.#j.logILIASRequest("leavePrivateRoom"),this.#te("privateRoom-leave")}inviteToPrivateRoom(e,t){this.#te("inviteUsersToPrivateRoom-"+t,{user:e})}clear(){this.#te("clear")}kick(e){this.#te("kick",{user:e})}ban(e){this.#te("ban-active",{user:e})}#te(e,t={},s=(e=>this.#se(e))){this.#ee(e,t).then((e=>e.json())).then(s)}#se(e){return this.#j.logILIASResponse("default"),!!e.success||(alert(e.reason),!1)}}class x{logServerResponse(e){this.#ie("Server-Response",e)}logServerRequest(e){this.#ie("Server-Request",e)}logILIASResponse(e){this.#ie("ILIAS-Response",e)}logILIASRequest(e){this.#ie("ILIAS-Request",e)}#ie(e,t){console.log(e,t)}}var M=({closeModal:e,showModal:t,node:s},i,n,o,a)=>{const l=s.querySelector("input[type=text]");let c=null;t(),s.querySelector("form").addEventListener("submit",(t=>(t.preventDefault(),null!==c&&(n.inviteToPrivateRoom(c,"byId"),e()),!1)));const h=function(e,t){let s=e;e.classList.add("ilNoDisplayChat"),t.classList.add("ilNoDisplayChat");const i=function(){s.classList.add("ilNoDisplayChat")},n=function(e){i(),s=e,s.classList.remove("ilNoDisplayChat")};return{loaded:function(e){return function(s){return s.length?i():n(t),e(s)}},loading:function(){n(e),s=e},noRequest:i}}(document.querySelector("#invite_users_loading"),document.querySelector("#invite_users_no_user"));document.querySelector("#invite_users_container"),l.value="",r.default(l).autocomplete({appendTo:l.parentNode,source:(e,t)=>function(e,t,s){const i=e=>t=>t[e]();return t("inviteUsersToPrivateRoom-getUserList",{q:s}).then(i("json")).then((t=>t.items.filter((function(t){return!e.has(t.id)}))))}(o,a,e.term).then(h.loaded(t)),search:function(){return c=null,this.value.length>2?(h.loading(),!0):(h.noRequest(),!1)},select:(e,t)=>{c=t.item.id}})};const A=e=>{const t=new w,s=new w,i=new x,r=(a=e.apiEndpointTemplate,(e,t={})=>{const s=new URL(a.replace(/postMessage/,e));return Object.entries(t).forEach((e=>s.searchParams.set(...e))),fetch(s)});var a;const l=((e,t=(e=>"#"+e+"#"))=>(s,i,...n)=>{let r=e[s];if(!r)return t(s,i,...n);for(const e in i||{})r=r.split("#"+e+"#").join(i[e]);return r})(e.lang,n.default.Language.txt.bind(n.default.Language)),h=e=>T(e).then((e=>e())),d=new g(e.initial.profile_image_url,e.initial.no_profile_image_url),p=new q(r,i),m=new u(F("chat_users"),(F("ilChatUserRowTemplate")||{}).innerHTML,(t=>t===e.initial.userinfo.id),d,O(u.actionList(l,p,h,(e=>j(t,e))),e.initial)),f=new c(F("chat_messages"),e.initial.userinfo.id,e.initial.state,d,s,l),v=new L(e.initial.userinfo,t,f,e.scope,s,e.initial.redirect_url,i);return{bindEvents:function(){t.onChange(m.userListChanged.bind(m)),s.onChange(f.typingListChanged.bind(f)),J("auto-scroll-toggle",(e=>f.enableAutoScroll(e))),J("system-messages-toggle",(e=>f.enableSystemMessages(e))),J("system-messages-toggle",(t=>D(t,e.initial))),R.onArrived("invite-modal",(([e,s,i])=>B("invite-button",(()=>{M({node:e,showModal:s,closeModal:i},0,p,t,r)})))),B("clear-history-button",(()=>N(h,p))),((e,t,s)=>{const i=e.querySelector("#submit_message_text");function n(){const e=i.value;if(""!==e.trim()){const n={content:e,format:{}};i.value="",s.release(),t(n),i.focus()}}e.querySelector("#submit_message").addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),n()})),i.addEventListener("input",C(e.querySelector("#chat-shadow"),i,3)),i.addEventListener("keydown",(e=>{13!==(e.keyCode||e.which)||e.shiftKey||(e.preventDefault(),e.stopPropagation(),i.blur(),n())})),i.addEventListener("keyup",(e=>{s[13===(e.keyCode||e.which)?"release":"heartbeat"]()}))})(F("send-message-group"),(e=>v.sendMessage(e)),e.initial.userinfo.broadcast_typing?new I(v):new U)},processInitialData:function(){P(t,e.initial),H(f,e.initial)},connectToServer:function(){p.heartbeatInterval(12e4),v.init(o.default.connect(e.baseUrl+"/"+e.instance,{path:e.initial.subdirectory})),v.onLoggedIn((function(){v.enterRoom(e.scope,0)}))}}};const O=(e,t)=>{const s=t.userinfo.moderator?["kick","ban","chat"]:["chat"];return e.filter((e=>s.includes(e.name)))},j=(e,t)=>n.default.Chat.getConversation([n.default.OnScreenChat.user,e.find(t)]),D=(e,t)=>{fetch(t.system_message_update_url,{method:"POST",body:new URLSearchParams({state:Number(e)})})},N=(e,t,s)=>e("clear-history-modal").then((e=>{e&&t.clear()})),P=(e,t)=>e.setAll(Object.fromEntries(t.users.map((e=>{const t={id:e.id,username:e.login,profile_picture_visible:e.profile_picture_visible};return[t.id,t]})))),H=(e,t)=>Object.values(t.messages).forEach((t=>{t.timestamp=1e3*t.timestamp,e.addMessage(t)})),B=(e,t)=>{R.onArrived(e,(e=>e.addEventListener("click",t)))},J=(e,t)=>{B(e,(function(e){t(this.classList.contains("on"))}))},F=e=>document.getElementById(e);n.default.Chatroom={run:e=>{const{bindEvents:t,processInitialData:s,connectToServer:i}=A(e);t(),s(),i(),F("submit_message_text").focus()},runReadOnly:e=>{const{processInitialData:t}=A(e);t()},bus:R,expandableTextarea:function(e,t,s){const i=function(e){const t=document.querySelector(e);return console.assert(null!==t,"Could not find selector "+JSON.stringify(e)),t};return C(i(e),i(t),s)}}}(il,$,io);
