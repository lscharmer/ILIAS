/**
 * This file is part of ILIAS, a powerful learning management system
 * published by ILIAS open source e-Learning e.V.
 *
 * ILIAS is licensed with the GPL-3.0,
 * see https://www.gnu.org/licenses/gpl-3.0.en.html
 * You should have received a copy of said license along with the
 * source code, too.
 *
 * If this is not the case or you just want to try ILIAS, you'll find
 * us at:
 * https://www.ilias.de
 * https://github.com/ILIAS-eLearning
 */
!function(e,t,s){"use strict";function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var n=i(e),o=i(t),r=i(s);const a=e=>"0".repeat(Math.max(0,2-String(e)).length)+e,l=e=>t=>{let s=e("timeformat");const i=new Date(t);return s=s.replace(/H/,a(i.getHours())),s=s.replace(/i/,a(i.getMinutes())),s=s.replace(/s/,a(i.getSeconds())),s};class c{#e;#t;#s;#i;#n;#o;#r;#a;#l;#c;#h;constructor(e,t,s,i,n,o){this.#e=e,this.#t=t,this.#s=s,this.#i=i,this.#n=n,this.#o=o,this.#l=d(["messageContainer"]),this.#l.setAttribute("aria-live","polite"),this.#c=d(["typing-info"]),this.#c.setAttribute("aria-live","polite"),this.#h=()=>{},this.#d(),this.clearMessages(),this.#u()}addMessage(e){this.#h();const t=d(["messageLine","chat",!e.target||e.target.public?"public":"private"]),s=()=>{console.log(e.type)};let i=null;const o=e=>{i=e},r={message:()=>{const s=function(e,t){const s=d(["message-body"]);return s.appendChild(e),s.appendChild(t),s}(function(e,t){const s=d(["time-info"]);return s.textContent=t(e.timestamp),s}(e,l(this.#o)),function(e){const t=d([],"p");return t.textContent=e.content,n.default.ExtLink.autolink(t),t}(e));var i;this.#a(new Date(e.timestamp))&&(this.#l.appendChild(function(e,t){const s=d(["separator"]),i=d([],"p");return i.textContent=t(e.timestamp),s.appendChild(i),s}(e,(i=this.#o,e=>{let t=i("dateformat");const s=new Date(e);return t=t.replace(/Y/,s.getFullYear()),t=t.replace(/m/,a(s.getMonth()+1)),t=t.replace(/d/,a(s.getDate())),t}))),o(null)),e.from.id===this.#t&&t.classList.add("myself"),this.#r&&this.#r.id===e.from.id?(this.#r.node.appendChild(s),o(this.#r)):(t.appendChild(function(e,t,s){const i=d(["user"],"span"),n=d(["user"],"span"),o=d([],"img");t.imageOfUser(e.from.id).then(Reflect.set.bind(null,o,"src"));const r=d(["message-header"]);return i.textContent=s(e.timestamp),n.textContent=e.from.username,o.src=t.defaultImage(),r.appendChild(o),r.appendChild(n),r.appendChild(i),r}(e,this.#i,l(this.#o))),t.appendChild(s),this.#l.appendChild(t),o({id:e.from.id,node:t}))},connected:s,disconnected:s,private_room_entered:s,private_room_left:s,notice:()=>{const t=d(["separator","system-message"]),s=d([],"p");s.innerHTML=this.#o(e.content,e.data),t.appendChild(s),this.#l.appendChild(t)},error:s,userjustkicked:s};(r[e.type]||s)(),this.#r=i,this.#s.scrolling&&(this.#e.scrollTop=this.#l.getBoundingClientRect().height)}clearMessages(){this.#l.innerHTML="",this.#r=null,this.#a=h();const e=d(["separator"]),t=d([],"p");t.innerHTML=this.#o("welcome_to_chat"),e.appendChild(t),this.#l.appendChild(e),this.#h=e.remove.bind(e)}typingListChanged(){const e=Object.values(this.#n.all());0===e.length?this.#c.textContent="":1===e.length?this.#c.textContent=this.#o("chat_user_x_is_typing",e[0]):this.#c.textContent=this.#o("chat_users_are_typing")}enableAutoScroll(e){this.#s.scrolling=Boolean(e),this.#d()}enableSystemMessages(e){this.#s.show_auto_msg=Boolean(e),this.#d()}#u(){this.#e.appendChild(this.#l);const e=d(["fader"]);this.#e.appendChild(e),e.appendChild(this.#c)}#d(){this.#e.classList[this.#s.show_auto_msg?"remove":"add"]("hide-system-messages")}}const h=()=>{let e=null;return t=>{const s=!e||e.getDate()!=t.getDate()||e.getMonth()!=t.getMonth()||e.getFullYear()!=t.getFullYear();return e=t,s}};const d=(e,t)=>{const s=document.createElement(t||"div");return(e||[]).forEach((e=>s.classList.add(e))),s};class u{#e;#g;#i;#p;#m;#f;#v;constructor(e,t,s,i){this.#e=e,this.#g=t,this.#i=s,this.#p=e&&e.querySelector(".no_users"),this.#m={},this.#f=[],this.#v=i}userListChanged(e){e.removed.forEach((({key:e})=>this.remove(e))),e.added.forEach((({value:e})=>this.add(e)))}add(e){if(this.#m[e.id])return!1;const t=this.#y(e);return e.hide||this.#f.push(String(e.id)),this.#e.appendChild(t),this.#m[e.id]=t,this.#b(),!0}remove(e){const t=this.#m[e];return!!t&&(t.remove(),this.#f=this.#f.filter((t=>t!==e)),delete this.#m[e],this.#b(),!0)}setUsers(e){const t=e.map((e=>String(e.id)));Object.keys(this.#m).filter((e=>!t.includes(e))).forEach(this.remove.bind(this)),e.forEach(this.add.bind(this))}static actionList(e,t,s,i){return[{name:"kick",label:e("kick"),callback:function(e){s("kick-modal").then((function(s){s&&t.kick(e)}))}},{name:"ban",label:e("ban"),callback:function(e){s("ban-modal").then((function(s){s&&t.ban(e)}))}},{name:"chat",label:e("start_private_chat"),callback:i}]}#y(e){const t=(new DOMParser).parseFromString(this.#g,"text/html").body.firstChild,s=t.querySelector("[data-placeholder=USERNAME]"),i=t.querySelector("img");return s.parentNode.replaceChild(document.createTextNode(e.label),s),i.setAttribute("src",this.#i.defaultImage()),this.#i.imageOfUser(e.id).then(i.setAttribute.bind(i,"src")),e.hide&&t.classList.add("ilNoDisplay"),g(this.#v,e.id,t),t}#b(){this.#p.classList[this.#f.length?"add":"remove"]("ilNoDisplay")}}const g=(e,t,s)=>{s.querySelector(".chatroom-user-action-dropdown").classList.remove("ilNoDisplay");const i=s.querySelector(".ilChatroomDropdownOptions");e.forEach((e=>i.appendChild((e=>{const s=document.createElement("li"),i=document.createElement("a"),n=document.createElement("span");return s.appendChild(i),i.appendChild(n),n.textContent=e.label,i.addEventListener("click",(()=>e.callback(t))),s})(e))))};class p{#C;#k;#L;#S;#w;constructor(e,t){this.#C=e,this.#k=t,this.#L={},this.#S={},this.#w=()=>{}}imageOfUser(e){return this.#L[e]?Promise.resolve(this.#L[e]):this.#I(e)}imagesOfUsers(e){return Promise.all(e.map(this.imageOfUser.bind(this)))}defaultImage(){return this.#k}#I(e){return new Promise(((t,s)=>{this.#S[e]=this.#S[e]||[],this.#S[e].push({resolve:t,reject:s}),this.#w(),this.#w=clearTimeout.bind(null,setTimeout(this.#R.bind(this),20))}))}#R(){fetch(this.#C+"&usr_ids="+Object.keys(this.#S).join(",")).then((e=>e.json())).then((e=>{const t=this.#S;this.#S={},Object.entries(e).map((([e,t])=>(this.#L[e]=t.profile_image,e))).forEach((e=>{t[e].forEach((({resolve:t})=>t(this.#L[e])))}))})).catch((e=>{const t=this.#S;this.#S={},Object.values(t).flatMap((e=>e)).forEach((({reject:t})=>t(e)))}))}}const m=["padding-top","padding-bottom","padding-left","padding-right","margin-left","margin-right","margin-top","margin-bottom","width","font-size","font-family","font-style","font-weight","line-height","font-variant","text-transform","letter-spacing","border","box-sizing","display"],f=(e,t)=>{const s=window.getComputedStyle(e);m.forEach((function(e){t.style[e]=s[e]}))},v=e=>{let t="";return s=>{s!==t&&(e.style.height=s,t=s)}},y=e=>{const t=e.value;e.value="";const s=e.scrollHeight;e.value="\n";const i=e.scrollHeight-s;return e.value=t,i},b=(e,t)=>{const s=e.value;e.value="\n".repeat(t-1);const i=e.scrollHeight;return e.value=s,i},C=e=>{const t=document.createElement("textarea");return t.style.height=window.getComputedStyle(e).height,t.setAttribute("area-hidden","true"),t.readOnly=!0,t.disabled=!0,t},k=e=>{let t=()=>{const s=e();return t=()=>s,s};return()=>t()};function L(e,t,s){const i=C(t),n=v(t),o=k((()=>y(i))),r=k((()=>b(i,s))),a=()=>{i.value="";const e=i.scrollHeight,a=t.clientHeight;i.value=t.value;const l=i.scrollHeight,c=parseInt((l-e)/o()+1);l>e?n(c<=s?l+"px":r()+"px"):l<a&&n("")};return()=>{e.appendChild(i),f(t,i),a(),i.remove()}}class S{#U;#_;#E;#q;#n;#T;#x;#M;constructor(e,t,s,i,n,o,r){this.#U=e,this.#_=t,this.#E=s,this.#q=i,this.#n=n,this.#T=o,this.#x=r}init(e){this.#M=e,this.#M.on("message",this.#A.bind(this)),this.#M.on("connect",(()=>{this.#M.emit("login",this.#U.login,this.#U.id)})),this.#M.on("user_invited",this.#O.bind(this)),this.#M.on("private_room_entered",this.#D.bind(this)),this.#M.on("connected",this.#j.bind(this)),this.#M.on("userjustkicked",this.#P.bind(this)),this.#M.on("userjustbanned",this.#N.bind(this)),this.#M.on("clear",this.#H.bind(this)),this.#M.on("notice",this.#B.bind(this)),this.#M.on("userStartedTyping",this.#F.bind(this)),this.#M.on("userStoppedTyping",this.#K.bind(this)),this.#M.on("userlist",this.#Y.bind(this)),this.#M.on("shutdown",(function(){this.#M.removeAllListeners(),this.#M.close(),window.location.href=this.#T})),window.addEventListener("beforeunload",(()=>{this.#M.close()}))}enterRoom(){this.#x.logServerRequest("enterRoom"),this.#M.emit("enterRoom",this.#q)}onLoggedIn(e){this.#M.on("loggedIn",e)}userStartedTyping(){this.#x.logServerRequest("userStartedTyping"),this.#M.emit("userStartedTyping",this.#q)}userStoppedTyping(){this.#x.logServerRequest("userStoppedTyping"),this.#M.emit("userStoppedTyping",this.#q)}sendMessage(e){this.#M.emit("message",e,this.#q)}#A(e){this.#E.addMessage(e)}#O(e){}#D(e){this.#x.logServerResponse("onPrivateRoomEntered")}#j(e){Object.values(e.users).forEach((function(t){let s={id:t.id,label:t.login,type:"user"};this.#_.add(s),this.#E.addMessage({login:s.label,timestamp:e.timestamp,type:"connected"})}))}#P(e){this.#x.logServerResponse("onUserKicked"),this.#_.remove(this.#U.id),window.location.href=this.#T+"&msg=kicked"}#N(e){this.#M&&(this.#M.removeAllListeners(),this.#M.close()),window.location.href=this.#T+"&msg=banned"}#H(){this.#E.clearMessages()}#B(e){this.#E.addMessage(e)}#F(e){this.#x.logServerResponse("onUserStartedTyping");const t=JSON.parse(e.subscriber);e.roomId,this.#n.add(t.id,t.username)}#K(e){this.#x.logServerResponse("onUserStoppedTyping");const t=JSON.parse(e.subscriber);e.roomId,this.#n.remove(t.id)}#Y(e){const t=e.users;this.#x.logServerResponse("onUserlist"),this.#_.setAll(Object.fromEntries(Object.values(t).map((e=>{const t={id:e.id,label:e.username,type:"user",hide:e.id==this.#U.id};return[t.id,t]}))))}}const w=(e,t)=>Object.keys(e).filter((e=>!Reflect.has(t,e))).map((t=>({key:t,value:e[t]})));class I{#J;#z;constructor(){this.#J={},this.#z=[]}find(e){return this.#J[e]}has(e){return Reflect.has(this.#J,String(e))}onChange(e){this.#z.push(e)}add(e,t){e=String(e),this.#J[e]=t,this.#$({added:[{key:e,value:t}],removed:[]})}remove(e){if(e=String(e),!Reflect.has(this.#J,e))return;const t=this.#J[e];delete this.#J[e],this.#$({added:[],removed:[{key:e,value:t}]})}setAll(e){const t={added:w(e,this.#J),removed:w(this.#J,e)};this.#J=e,this.#$(t)}all(){return this.#J}#$(e){this.#z.forEach((t=>t(e)))}}class R{#G;#Q;#w;constructor(e){this.#G=e,this.#Q=!1,this.#w=()=>{},window.addEventListener("beforeunload",this.release.bind(this))}release(){this.#w(),this.#Q&&(this.#G.userStoppedTyping(),this.#Q=!1)}heartbeat(){this.#w(),this.#Q||(this.#G.userStartedTyping(),this.#Q=!0),this.#w=clearTimeout.bind(null,setTimeout(this.release.bind(this),5e3))}}class U{release(){}heartbeat(){}}var _=function(){const e={},t={};return{send(s,i){if(e[s])throw new Error("Name already provided.");e[s]=i;const n=t[s]||[];delete t[s],n.forEach((e=>e(i)))},onArrived(s,i){e[s]?i(e[s]):(t[s]=t[s]||[],t[s].push(i))}}}();const E=()=>{},q=(e=>{const t={};return s=>(t[s]||(t[s]=e(s)),t[s])})((e=>new Promise((t=>_.onArrived(e,(([e,s,i])=>{let n=E;e.querySelector("form").addEventListener("submit",(e=>(e.preventDefault(),n(!0),n=E,i(),!1))),t((()=>(s(),new Promise((e=>{n=e})))))}))))));class T{#V;#x;constructor(e,t){this.#V=e,this.#x=t}heartbeatInterval(e){const t=()=>{};window.setInterval((()=>this.#W("poll",{},t)),e)}leavePrivateRoom(){this.#x.logILIASRequest("leavePrivateRoom"),this.#W("privateRoom-leave")}inviteToPrivateRoom(e,t){this.#W("inviteUsersToPrivateRoom-"+t,{user:e})}clear(){this.#W("clear")}kick(e){this.#W("kick",{user:e})}ban(e){this.#W("ban-active",{user:e})}#W(e,t={},s=(e=>this.#X(e))){this.#V(e,t).then((e=>e.json())).then(s)}#X(e){return this.#x.logILIASResponse("default"),!!e.success||(alert(e.reason),!1)}}class x{logServerResponse(e){this.#Z("Server-Response",e)}logServerRequest(e){this.#Z("Server-Request",e)}logILIASResponse(e){this.#Z("ILIAS-Response",e)}logILIASRequest(e){this.#Z("ILIAS-Request",e)}#Z(e,t){console.log(e,t)}}var M=({closeModal:e,showModal:t,node:s},i,n,r,a)=>{const l=s.querySelector("input[type=text]");let c=null;t(),s.querySelector("form").addEventListener("submit",(t=>(t.preventDefault(),null!==c&&(n.inviteToPrivateRoom(c,"byId"),e()),!1)));const h=function(e,t){let s=e;e.classList.add("ilNoDisplayChat"),t.classList.add("ilNoDisplayChat");const i=function(){s.classList.add("ilNoDisplayChat")},n=function(e){i(),s=e,s.classList.remove("ilNoDisplayChat")};return{loaded:function(e){return function(s){return s.length?i():n(t),e(s)}},loading:function(){n(e),s=e},noRequest:i}}(document.querySelector("#invite_users_loading"),document.querySelector("#invite_users_no_user"));document.querySelector("#invite_users_container"),l.value="",o.default(l).autocomplete({appendTo:l.parentNode,source:(e,t)=>function(e,t,s){const i=e=>t=>t[e]();return t("inviteUsersToPrivateRoom-getUserList",{q:s}).then(i("json")).then((t=>t.items.filter((function(t){return!e.has(t.id)}))))}(r,a,e.term).then(h.loaded(t)),search:function(){return c=null,this.value.length>2?(h.loading(),!0):(h.noRequest(),!1)},select:(e,t)=>{c=t.item.id}})};const A=e=>{const t=new I,s=new I,i=new x,o=(a=e.apiEndpointTemplate,(e,t={})=>{const s=new URL(a.replace(/postMessage/,e));return Object.entries(t).forEach((e=>s.searchParams.set(...e))),fetch(s)});var a;const l=((e,t=(e=>"#"+e+"#"))=>(s,i,...n)=>{let o=e[s];if(!o)return t(s,i,...n);for(const e in i||{})o=o.split("#"+e+"#").join(i[e]);return o})(e.lang,n.default.Language.txt.bind(n.default.Language)),h=e=>q(e).then((e=>e())),d=new p(e.initial.profile_image_url,e.initial.no_profile_image_url),g=new T(o,i),m=new u(K("chat_users"),(K("ilChatUserRowTemplate")||{}).innerHTML,d,O(u.actionList(l,g,h,(e=>D(t,e))),e.initial)),f=new c(K("chat_messages"),e.initial.userinfo.id,e.initial.state,d,s,l),v=new S(e.initial.userinfo,t,f,e.scope,s,e.initial.redirect_url,i);return{bindEvents:function(){t.onChange(m.userListChanged.bind(m)),s.onChange(f.typingListChanged.bind(f)),F("auto-scroll-toggle",(e=>f.enableAutoScroll(e))),F("system-messages-toggle",(e=>f.enableSystemMessages(e))),F("system-messages-toggle",(t=>j(t,e.initial))),_.onArrived("invite-modal",(([e,s,i])=>B("invite-button",(()=>{M({node:e,showModal:s,closeModal:i},0,g,t,o)})))),B("clear-history-button",(()=>P(h,g))),((e,t,s)=>{const i=e.querySelector("#submit_message_text");function n(){const e=i.value;if(""!==e.trim()){const n={content:e,format:{}};i.value="",s.release(),t(n),i.focus()}}e.querySelector("#submit_message").addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),n()})),i.addEventListener("input",L(e.querySelector("#chat-shadow"),i,3)),i.addEventListener("keydown",(e=>{13!==(e.keyCode||e.which)||e.shiftKey||(e.preventDefault(),e.stopPropagation(),i.blur(),n())})),i.addEventListener("keyup",(e=>{s[13===(e.keyCode||e.which)?"release":"heartbeat"]()}))})(K("send-message-group"),(e=>v.sendMessage(e)),e.initial.userinfo.broadcast_typing?new R(v):new U)},processInitialData:function(){N(t,e.initial),H(f,e.initial)},connectToServer:function(){g.heartbeatInterval(12e4),v.init(r.default.connect(e.baseUrl+"/"+e.instance,{path:e.initial.subdirectory})),v.onLoggedIn((function(){v.enterRoom(e.scope,0)}))}}};const O=(e,t)=>{const s=t.userinfo.moderator?["kick","ban","chat"]:["chat"];return e.filter((e=>s.includes(e.name)))},D=(e,t)=>n.default.Chat.getConversation([n.default.OnScreenChat.user,e.find(t)]),j=(e,t)=>{fetch(t.system_message_update_url,{method:"POST",body:new URLSearchParams({state:Number(e)})})},P=(e,t,s)=>e("clear-history-modal").then((e=>{e&&t.clear()})),N=(e,t)=>e.setAll(Object.fromEntries(t.users.map((e=>{const s={id:e.id,label:e.login,type:"user",hide:e.id==t.userinfo.id};return[s.id,s]})))),H=(e,t)=>Object.values(t.messages).forEach((t=>{t.timestamp=1e3*t.timestamp,e.addMessage(t)})),B=(e,t)=>{_.onArrived(e,(e=>e.addEventListener("click",t)))},F=(e,t)=>{B(e,(function(e){t(this.classList.contains("on"))}))},K=e=>document.getElementById(e);n.default.Chatroom={run:e=>{const{bindEvents:t,processInitialData:s,connectToServer:i}=A(e);t(),s(),i(),K("submit_message_text").focus()},runReadOnly:e=>{const{processInitialData:t}=A(e);t()},bus:_,expandableTextarea:function(e,t,s){const i=function(e){const t=document.querySelector(e);return console.assert(null!==t,"Could not find selector "+JSON.stringify(e)),t};return L(i(e),i(t),s)}}}(il,$,io);
